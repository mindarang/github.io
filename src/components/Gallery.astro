---
import { Image, getImage } from "astro:assets";

const INITIAL_DISPLAY_COUNT = 9;

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/gallery/*"
);
const imagePaths = Object.keys(images)
  .filter((imagePath) => {
    return imagePath.startsWith(`/src/assets/gallery/`);
  })
  .slice(0, INITIAL_DISPLAY_COUNT);
---

<section class="gallery_container">
  <div class="title">GALLERY</div>
  <div class="gallery_grid" id="gallery-grid">
    {
      imagePaths.map(async (imagePath, index) => {
        const imageMod = await images[imagePath]();
        const image = imageMod.default;
        const optimizedFull = await getImage({
          src: image,
          width: 1200,
          quality: 80,
          format: "webp",
        });
        return (
          <a
            href={optimizedFull.src}
            data-pswp-width={optimizedFull.attributes.width}
            data-pswp-height={optimizedFull.attributes.height}
            class="gallery_item"
            target="_blank"
          >
            <Image
              src={image}
              alt={`Gallery ${index + 1}`}
              width={400}
              height={400}
              format="webp"
              quality={70}
            />
          </a>
        );
      })
    }
  </div>
</section>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";

  function initPhotoSwipe() {
    const lightbox = new PhotoSwipeLightbox({
      gallery: "#gallery-grid",
      children: "a",
      pswpModule: () => import("photoswipe"),
    });
    lightbox.init();
  }

  // Initialize on load and on view transitions if used
  document.addEventListener("DOMContentLoaded", () => {
    initPhotoSwipe();
  });

  // For Astro View Transitions compatibility
  document.addEventListener("astro:page-load", () => {
    initPhotoSwipe();
  });
</script>

<style>
  .gallery_container {
    padding: var(--section-padding-y) 0;
    background-color: #fff;
  }

  .title {
    color: #9b785c;
    font-size: 0.85rem;
    letter-spacing: 3px;
    margin-bottom: 40px;
    font-family: "Crimson Text", serif;
    text-align: center;
  }

  .gallery_grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 4px;
    width: 100%;
    padding: 0;
  }

  .gallery_item {
    overflow: hidden;
    display: block;
    position: relative;
  }

  .gallery_item img {
    width: 100%;
    height: auto;
    object-fit: cover;
    display: block;
    aspect-ratio: 1 / 1;
    object-fit: cover;
  }

  .gallery_item:hover img {
    transform: scale(1.05);
  }
</style>
