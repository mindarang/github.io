---
import "photoswipe/style.css";
import { Image, getImage } from "astro:assets";

const imageFiles = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/gallery/*.{jpeg,jpg,png,gif,JPG,JPEG,PNG,GIF}"
);
const imagePaths = Object.keys(imageFiles).sort((a, b) => {
  const getNum = (str: string) =>
    parseInt(str.match(/gallery_(\d+)/)?.[1] || "0", 10);
  return getNum(a) - getNum(b);
});

const INITIAL_DISPLAY_COUNT = 9;
---

<section class="gallery_container">
  <div class="title">GALLERY</div>
  <div class="gallery_grid" id="gallery-grid">
    {
      imagePaths.map(async (imagePath, index) => {
        const imageMod = await imageFiles[imagePath]();
        const image = imageMod.default;
        const optimizedImage = await getImage({ src: image });

        return (
          <a
            href={optimizedImage.src}
            data-pswp-width={optimizedImage.attributes.width}
            data-pswp-height={optimizedImage.attributes.height}
            class={`gallery_item ${index >= INITIAL_DISPLAY_COUNT ? "hidden" : ""}`}
            target="_blank"
          >
            <Image
              src={image}
              alt={`Gallery ${index + 1}`}
              width={400}
              densities={[1.5, 2]}
              quality="mid"
            />
          </a>
        );
      })
    }
  </div>

  {
    imagePaths.length > INITIAL_DISPLAY_COUNT && (
      <div class="more-btn-container">
        <button id="show-more-btn" class="show-more-btn">
          더보기
          <svg
            width="12"
            height="12"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7 10L12 15L17 10"
              stroke="#9B785C"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        <button id="collapse-btn" class="show-more-btn" style="display: none;">
          접기
          <svg
            width="12"
            height="12"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7 15L12 10L17 15"
              stroke="#9B785C"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
    )
  }
</section>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";

  const lightbox = new PhotoSwipeLightbox({
    gallery: "#gallery-grid",
    children: "a",
    pswpModule: () => import("photoswipe"),
  });
  lightbox.init();

  // Toggle Functionality
  const showMoreBtn = document.getElementById("show-more-btn");
  const collapseBtn = document.getElementById("collapse-btn");
  const galleryGrid = document.getElementById("gallery-grid");

  if (showMoreBtn && collapseBtn && galleryGrid) {
    const items = galleryGrid.querySelectorAll(".gallery_item");
    const INITIAL_COUNT = 9;

    showMoreBtn.addEventListener("click", () => {
      items.forEach((item) => item.classList.remove("hidden"));
      showMoreBtn.style.display = "none";
      collapseBtn.style.display = "flex";
    });

    collapseBtn.addEventListener("click", () => {
      items.forEach((item, index) => {
        if (index >= INITIAL_COUNT) {
          item.classList.add("hidden");
        }
      });
      collapseBtn.style.display = "none";
      showMoreBtn.style.display = "flex";

      const galleryTop = galleryGrid.offsetTop;
      window.scrollTo({ top: galleryTop - 100, behavior: "smooth" });
    });
  }
</script>

<style>
  .gallery_container {
    padding: 60px 0;
    background-color: #fff;
  }

  .title {
    color: #9b785c;
    font-size: 0.85rem;
    letter-spacing: 3px;
    margin-bottom: 40px;
    font-family: "Crimson Text", serif;
    text-align: center;
  }

  .gallery_grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 4px;
    width: 100%;
    padding: 0;
  }

  .gallery_item {
    overflow: hidden;
    display: block;
    position: relative;
  }

  .gallery_item.hidden {
    display: none;
  }

  .gallery_item img {
    width: 100%;
    height: auto;
    object-fit: cover;
    display: block;
    aspect-ratio: 1 / 1;
    transition: transform 0.3s ease;
  }

  .gallery_item:hover img {
    transform: scale(1.05);
  }

  .more-btn-container {
    display: flex;
    justify-content: center;
    margin-top: 30px;
  }

  .show-more-btn {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    color: #333;
    padding: 10px 40px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-family: "Noto Sans KR", sans-serif;
    transition: all 0.2s ease;
  }

  .show-more-btn:hover {
    background: #f0f0f0;
  }
</style>
